name: Running Test Script
on:
  workflow_dispatch:

env:
  K3S_VERSION: v1.30.1+k3s1

jobs:
  build-server:
    name: Build rancher server
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set Up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
        shell: bash

      - name: Run Build Server
        run: |
          ./scripts/build-server
        shell: bash

      - name: Upload Rancher Binary
        uses: actions/upload-artifact@v4
        with:
          name: rancher
          path: bin/rancher

  integration-testing:
    name: Integration tests
    runs-on: ubuntu-latest
    needs:
      - build-server
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Rancher Binary
        uses: actions/download-artifact@v4
        with:
          name: rancher
          path: bin

      - name: Make Rancher Binary Executable
        run: chmod +x ./bin/rancher
        shell: bash

      - name: Install k3s
        run: |
          curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=${{ env.K3S_VERSION }} sh -
        shell: bash

      - name: Verify k3s Installation
        run: |
          k3s --version
        shell: bash

      - name: Run Integration Tests
        run: |
          sudo ./scripts/test || (
            cat /tmp/rancher.log &&
            echo "Checking k3s logs..." &&
            (sudo cat /var/log/k3s.log || sudo cat /var/lib/rancher/k3s/server/logs/k3s.log || echo "k3s logs not found") &&
            false
          )
        shell: bash
        env:
          ARCH: amd64
          CI: true
          AGENT_TAG: latest
          CATTLE_SYSTEM_AGENT_VERSION: v0.3.6

      - name: Upload Rancher Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: rancher-logs
          path: /tmp/rancher.log
